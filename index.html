<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teach AI - Web Version</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai",
          "@supabase/supabase-js": "https://esm.run/@supabase/supabase-js"
        }
      }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-container { transition: transform 0.3s ease, opacity 0.3s ease; transform: scale(0.95); opacity: 0; }
        .modal-container.active { transform: scale(1); opacity: 1; }
        
        @media (min-width: 768px) {
            #app-container {
                width: 100%; max-width: 1100px; height: 90vh; max-height: 850px;
                border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                flex-direction: row;
            }
            #sidebar { position: static; transform: translateX(0); width: 288px; }
        }
    </style>
</head>
<body class="overflow-hidden h-screen flex items-center justify-center">

    <div id="app-wrapper" class="w-full h-full flex items-center justify-center">
        <div id="app-container" class="w-full h-full bg-white flex flex-col relative overflow-hidden">

            <div id="sidebar" class="absolute md:relative top-0 left-0 h-full w-72 bg-gray-800 text-white transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-30 p-6 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Teach AI</h2>
                    <button onclick="window.app.startNewConversation()" class="p-2 rounded-full hover:bg-gray-700"><i class="fas fa-plus"></i></button>
                </div>
                <h3 class="text-sm font-semibold text-gray-400 uppercase mb-2">Hist√≥rico</h3>
                <div id="history-list" class="flex-grow overflow-y-auto space-y-2 pr-2 text-sm text-gray-500">Carregando...</div>
                <div class="border-t border-gray-600 pt-4 mt-4 space-y-2">
                    <button onclick="window.app.showScreen('dev-screen')" class="w-full text-left p-2 hover:bg-gray-700 rounded flex gap-3"><i class="fas fa-tools w-5"></i> Configura√ß√µes</button>
                    <button onclick="window.app.showScreen('start-screen')" class="w-full text-left p-2 hover:bg-gray-700 rounded flex gap-3"><i class="fas fa-sign-out-alt w-5"></i> Sair</button>
                </div>
            </div>

            <div class="relative flex flex-col w-full h-full bg-gray-50 flex-grow">
                <div id="sidebar-overlay" class="hidden absolute inset-0 bg-black bg-opacity-50 z-20 md:hidden" onclick="window.app.toggleSidebar()"></div>

                <div id="start-screen" class="flex flex-col h-full p-8 text-center bg-white items-center justify-center">
                    <div class="w-48 h-48 bg-indigo-100 rounded-full flex items-center justify-center mb-8"><i class="fas fa-robot text-7xl text-indigo-500"></i></div>
                    <h1 class="text-4xl font-bold text-gray-800">Teach AI Web</h1>
                    <p class="text-gray-500 mt-2 text-lg">Seu assistente pessoal, direto no navegador.</p>
                    <button onclick="window.app.startNewConversation()" class="mt-8 bg-indigo-600 text-white py-3 px-8 rounded-xl font-semibold hover:bg-indigo-700 transition">Come√ßar</button>
                </div>

                <div id="chat-screen" class="hidden flex-col h-full">
                    <header class="flex items-center p-4 border-b bg-white">
                        <button onclick="window.app.toggleSidebar()" class="md:hidden mr-4"><i class="fas fa-bars"></i></button>
                        <div class="flex-grow text-center">
                            <h2 class="font-semibold">Chat</h2>
                            <p id="chat-subject-text" class="text-xs text-green-600">Geral</p>
                        </div>
                    </header>
                    <main id="chat-body" class="flex-grow p-4 overflow-y-auto space-y-4"></main>
                    <footer class="p-4 bg-white border-t">
                        <div class="flex justify-center gap-2 mb-3 text-sm overflow-x-auto">
                            <button onclick="window.app.showModal('subject-modal')" class="text-indigo-600 font-medium px-2"><i class="fas fa-book"></i> Mat√©ria</button>
                            <button onclick="window.app.showModal('style-modal')" class="text-indigo-600 font-medium px-2"><i class="fas fa-lightbulb"></i> Estilo</button>
                        </div>
                        <div class="flex gap-2">
                            <input id="chat-input" type="text" class="flex-grow p-3 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Digite sua mensagem...">
                            <button onclick="window.app.sendMessage()" class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </footer>
                </div>

                <div id="dev-screen" class="hidden flex-col h-full bg-gray-50">
                    <header class="p-4 border-b bg-white flex items-center">
                        <button onclick="window.app.goBack()" class="mr-4"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="font-bold">Configura√ß√µes</h2>
                    </header>
                    <main class="p-6 space-y-6 overflow-y-auto">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h3 class="font-bold mb-2">üß† Google Gemini API</h3>
                            <input id="api-key-input" type="password" placeholder="Cole sua API Key do Google AI Studio" class="w-full p-2 border rounded mb-2">
                            <button onclick="window.app.saveSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm">Salvar Key</button>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h3 class="font-bold mb-2">üóÑÔ∏è Conex√£o Supabase</h3>
                            <p class="text-xs text-gray-500 mb-2">Necess√°rio para salvar hist√≥rico e PDFs.</p>
                            <input id="supabase-url" placeholder="Supabase URL (https://...)" class="w-full p-2 border rounded mb-2">
                            <input id="supabase-key" type="password" placeholder="Supabase Anon Key" class="w-full p-2 border rounded mb-2">
                            <button onclick="window.app.saveSettings()" class="bg-green-600 text-white px-4 py-2 rounded text-sm">Conectar</button>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h3 class="font-bold mb-2">üìÑ Arquivos (PDF)</h3>
                            <div class="border-2 border-dashed p-4 text-center rounded mb-2 cursor-pointer" onclick="document.getElementById('pdf-upload').click()">
                                <input type="file" id="pdf-upload" accept=".pdf" class="hidden" multiple onchange="window.app.handleFileUpload(this)">
                                <p class="text-gray-500 text-sm">Clique para adicionar PDFs</p>
                            </div>
                            <div id="file-list" class="space-y-2"></div>
                        </div>
                    </main>
                </div>
            </div>

            <div id="modal-overlay" class="hidden absolute inset-0 bg-black bg-opacity-50 z-40" onclick="window.app.hideModals()"></div>
            
            <div id="subject-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center pointer-events-none">
                <div class="bg-white rounded-xl p-6 w-64 shadow-xl pointer-events-auto modal-container">
                    <h3 class="font-bold text-center mb-4">Escolha a Mat√©ria</h3>
                    <div id="subject-list" class="space-y-2"></div>
                </div>
            </div>

             <div id="style-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center pointer-events-none">
                <div class="bg-white rounded-xl p-6 w-64 shadow-xl pointer-events-auto modal-container">
                    <h3 class="font-bold text-center mb-4">Estilo de Resposta</h3>
                    <button onclick="window.app.setAnswerStyle(false)" class="w-full p-2 bg-gray-100 rounded mb-2 hover:bg-gray-200">üí° Dica / Guia</button>
                    <button onclick="window.app.setAnswerStyle(true)" class="w-full p-2 bg-gray-100 rounded hover:bg-gray-200">‚úÖ Resposta Completa</button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import { createClient } from "@supabase/supabase-js";

        // --- Estado da Aplica√ß√£o ---
        const state = {
            geminiKey: localStorage.getItem('gemini_key') || '',
            supabaseUrl: localStorage.getItem('sb_url') || '',
            supabaseKey: localStorage.getItem('sb_key') || '',
            currentScreen: 'start-screen',
            activeConversationId: null,
            messages: [],
            files: [], // Lista de objetos { name, data: 'base64string...', type: 'application/pdf' }
            config: {
                subject: 'Geral',
                giveFinal: false
            },
            subjects: ['Matem√°tica', 'F√≠sica', 'Qu√≠mica', 'Hist√≥ria', 'Portugu√™s', 'Ingl√™s', 'Programa√ß√£o']
        };

        // --- Inicializa√ß√£o de Clientes ---
        let supabase = null;
        let genAI = null;

        function initClients() {
            if (state.supabaseUrl && state.supabaseKey) {
                try {
                    supabase = createClient(state.supabaseUrl, state.supabaseKey);
                    loadHistory();
                } catch (e) { console.error("Erro Supabase", e); }
            }
            if (state.geminiKey) {
                genAI = new GoogleGenerativeAI(state.geminiKey);
            }
            updateConfigUI();
        }

        // --- UI Helpers ---
        const el = (id) => document.getElementById(id);
        
        const ui = {
            showScreen: (screenId) => {
                ['start-screen', 'chat-screen', 'dev-screen'].forEach(id => el(id).classList.add('hidden'));
                ['start-screen', 'chat-screen', 'dev-screen'].forEach(id => el(id).classList.remove('flex'));
                
                const target = el(screenId);
                target.classList.remove('hidden');
                target.classList.add('flex');
                state.currentScreen = screenId;
                
                if(screenId === 'chat-screen') renderChat();
                if(window.innerWidth < 768) ui.toggleSidebar(false);
            },
            toggleSidebar: (force) => {
                const sb = el('sidebar');
                const overlay = el('sidebar-overlay');
                const isOpen = !sb.classList.contains('-translate-x-full');
                const shouldOpen = force !== undefined ? force : !isOpen;
                
                if (shouldOpen) {
                    sb.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sb.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            },
            showModal: (id) => {
                el('modal-overlay').classList.remove('hidden');
                const m = el(id);
                m.classList.remove('hidden');
                setTimeout(() => m.querySelector('.modal-container').classList.add('active'), 10);
            },
            hideModals: () => {
                el('modal-overlay').classList.add('hidden');
                document.querySelectorAll('[id$="-modal"]').forEach(m => {
                    m.querySelector('.modal-container')?.classList.remove('active');
                    setTimeout(() => m.classList.add('hidden'), 300);
                });
            }
        };

        // --- File Handling (Converte PDF para Base64 para envio inline) ---
        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        }

        // --- L√≥gica Principal ---

        window.app = {
            // Navega√ß√£o
            showScreen: ui.showScreen,
            toggleSidebar: ui.toggleSidebar,
            showModal: ui.showModal,
            hideModals: ui.hideModals,
            goBack: () => ui.showScreen('start-screen'),

            // Configura√ß√£o
            saveSettings: () => {
                const gKey = el('api-key-input').value.trim();
                const sUrl = el('supabase-url').value.trim();
                const sKey = el('supabase-key').value.trim();

                if(gKey) localStorage.setItem('gemini_key', gKey);
                if(sUrl) localStorage.setItem('sb_url', sUrl);
                if(sKey) localStorage.setItem('sb_key', sKey);
                
                state.geminiKey = gKey || state.geminiKey;
                state.supabaseUrl = sUrl || state.supabaseUrl;
                state.supabaseKey = sKey || state.supabaseKey;
                
                initClients();
                alert('Configura√ß√µes Salvas!');
            },

            // Upload de Arquivos
            handleFileUpload: async (input) => {
                if (!input.files.length) return;
                
                // Salvar no estado local (para mandar para o Gemini)
                for (const file of input.files) {
                    const part = await fileToGenerativePart(file);
                    state.files.push({
                        name: file.name,
                        part: part
                    });
                    
                    // Backup no Supabase (se configurado)
                    if (supabase) {
                        try {
                            const { error } = await supabase.storage.from('teach-ai').upload(`pdfs/${Date.now()}_${file.name}`, file);
                            if(error) console.error("Upload erro Supabase", error);
                        } catch(e) {}
                    }
                }
                renderFileList();
            },

            removeFile: (index) => {
                state.files.splice(index, 1);
                renderFileList();
            },

            // Chat
            startNewConversation: () => {
                state.activeConversationId = Date.now().toString();
                state.messages = [];
                state.files = []; // Reset files for new chat? Or keep? Let's clear for new context.
                renderFileList();
                ui.showScreen('chat-screen');
            },

            sendMessage: async () => {
                const input = el('chat-input');
                const text = input.value.trim();
                if (!text || !genAI) {
                    if(!genAI) alert("Configure a API Key do Google em Desenvolvedor primeiro.");
                    return;
                }

                // 1. UI Update (User)
                state.messages.push({ role: 'user', text: text });
                input.value = '';
                renderChat();
                
                // 2. Loading State
                state.messages.push({ role: 'model', text: 'Pensando...', loading: true });
                renderChat();

                try {
                    // 3. Call Gemini
                    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" }); // Use 1.5-flash which is stable
                    
                    const promptConfig = `
                        Voc√™ √© um professor particular.
                        Mat√©ria: ${state.config.subject}.
                        Estilo: ${state.config.giveFinal ? "D√™ a resposta completa e direta." : "D√™ dicas, guie o aluno, n√£o d√™ a resposta final de cara."}
                        Responda em Markdown.
                    `;

                    // Prepare history + files
                    // Nota: Gemini API stateless via REST usually expects full context in each turn or using chatSession.
                    // Para simplificar no browser, vamos usar chatSession mas injetando os arquivos na mensagem atual.
                    
                    const chat = model.startChat({
                        history: state.messages
                            .filter(m => !m.loading && m.role !== 'system') // Filter out UI logic
                            .map(m => ({ role: m.role, parts: [{ text: m.text }] }))
                    });

                    // Montar payload da mensagem atual (Texto + Arquivos carregados)
                    const parts = [{ text: promptConfig + "\n\nPergunta do aluno: " + text }];
                    state.files.forEach(f => parts.push(f.part.inlineData ? f.part : f.part));

                    const result = await chat.sendMessage(parts);
                    const responseText = result.response.text();

                    // 4. UI Update (AI)
                    state.messages.pop(); // Remove loading
                    state.messages.push({ role: 'model', text: responseText });
                    renderChat();
                    saveHistory();

                } catch (error) {
                    state.messages.pop();
                    state.messages.push({ role: 'model', text: `Erro: ${error.message}` });
                    renderChat();
                }
            },

            setAnswerStyle: (isDirect) => {
                state.config.giveFinal = isDirect;
                ui.hideModals();
            },
            
            selectSubject: (subj) => {
                state.config.subject = subj;
                el('chat-subject-text').textContent = subj;
                ui.hideModals();
            }
        };

        // --- Render Functions ---
        function renderFileList() {
            const list = el('file-list');
            list.innerHTML = '';
            state.files.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-100 p-2 rounded text-sm';
                div.innerHTML = `<span><i class="fas fa-file-pdf text-red-500 mr-2"></i>${f.name}</span> <button onclick="window.app.removeFile(${i})" class="text-red-500"><i class="fas fa-times"></i></button>`;
                list.appendChild(div);
            });
        }

        function renderChat() {
            const body = el('chat-body');
            body.innerHTML = '';
            state.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `flex w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `max-w-[85%] p-3 rounded-lg ${msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800'}`;
                
                if (msg.loading) {
                    bubble.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando arquivos e pensando...';
                } else {
                    // Simple markdown parse
                    let html = msg.text
                        .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                        .replace(/\n/g, '<br>');
                    bubble.innerHTML = html;
                }
                
                div.appendChild(bubble);
                body.appendChild(div);
            });
            body.scrollTop = body.scrollHeight;
        }

        async function saveHistory() {
            if (!supabase || !state.activeConversationId) return;
            // Salva conversa no Supabase (tabela: history, coluna: jsonb)
            // Em app real: Criar tabela 'conversations'
            try {
                // Upsert logic simplificada para arquivo JSON no Storage para manter compatibilidade com sua l√≥gica anterior
                const fileName = `history/${state.activeConversationId}.json`;
                const content = JSON.stringify(state.messages);
                const blob = new Blob([content], {type : 'application/json'});
                await supabase.storage.from('teach-ai').upload(fileName, blob, { upsert: true });
                loadHistory(); // Reload sidebar
            } catch (e) { console.log("Save history error", e); }
        }

        async function loadHistory() {
            const list = el('history-list');
            list.innerHTML = '';
            if(!supabase) { list.innerHTML = "Supabase desconectado."; return; }
            
            try {
                const { data, error } = await supabase.storage.from('teach-ai').list('history', { sortBy: { column: 'created_at', order: 'desc' } });
                if(data) {
                    data.forEach(file => {
                        const btn = document.createElement('button');
                        btn.className = "block w-full text-left p-2 hover:bg-gray-700 rounded truncate";
                        btn.textContent = `Conversa ${new Date(file.created_at).toLocaleDateString()}`;
                        // Load logic... (simplificado para UI apenas aqui)
                        list.appendChild(btn);
                    });
                }
            } catch(e) { list.innerHTML = "Erro ao carregar."; }
        }

        function updateConfigUI() {
            el('api-key-input').value = state.geminiKey;
            el('supabase-url').value = state.supabaseUrl;
            el('supabase-key').value = state.supabaseKey;
            
            // Popula mat√©rias
            const subList = el('subject-list');
            subList.innerHTML = '';
            state.subjects.forEach(s => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-2 hover:bg-gray-100 rounded";
                btn.textContent = s;
                btn.onclick = () => window.app.selectSubject(s);
                subList.appendChild(btn);
            });
        }

        // Boot
        document.addEventListener('DOMContentLoaded', () => {
            initClients();
            // Enter key handler
            el('chat-input').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') window.app.sendMessage();
            });
        });

    </script>
</body>
</html>

